from fastapi import APIRouter, UploadFile, Form
from typing import List
import os, json
from PIL import Image
from pdf2image import convert_from_bytes
from services.ai_parser import parse_invoice_from_image
from ReaderApi import get_keywords_from_db
from services.matching import match_product_with_keywords
from models import save_invoice
from fastapi.staticfiles import StaticFiles

router = APIRouter(prefix="/upload", tags=["Invoices"])

os.makedirs("images", exist_ok=True)

@router.post("/invoices/")
async def upload_invoices(files: List[UploadFile], client_id: int = Form(...)):
    keywords = get_keywords_from_db(client_id)
    results = []
    total_files = len(files)

    for file_index, file in enumerate(files, start=1):
        print(f"\nğŸ“¦ [{file_index}/{total_files}] Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: {file.filename}")
        try:
            # âœ… Ù„Ùˆ Ø§Ù„Ù…Ù„Ù PDF
            if file.filename.lower().endswith(".pdf"):
                pdf_bytes = await file.read()
                pages = convert_from_bytes(pdf_bytes, dpi=150, poppler_path=r"C:\\poppler-25.07.0\\Library\\bin")
                total_pages = len(pages)

                for idx, page in enumerate(pages, start=1):
                    print(f"   ğŸ§¾ Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙØ­Ø© {idx}/{total_pages} Ù…Ù† {file.filename}")
                    image_name = f"{file.filename}_page{idx}.jpg"
                    image_path = os.path.join("images", image_name)
                    page.save(image_path, "JPEG")
                    image_url = f"http://localhost:8000/images/{image_name}"

                    data = parse_invoice_from_image(image_path)
                    supplier = data.get("supplier_details", {}).get("name", "")
                    invoice = data.get("invoice_details", {})
                    invoice_summary = data.get("invoice_summary", {})
                    products = data.get("product_details", [])

                    inventory = [{"item_id": k["item_id"], "product_name": k["product_name"], "unit_price": k["unit_price"]} for k in keywords]
                    for p in products:
                        match = match_product_with_keywords(p["product_name"], keywords, inventory)
                        p["matched_inventory"] = match["product_name"] if match else ""

                    save_invoice(client_id, supplier, invoice, invoice_summary, products, image_url)

                    results.append({
                        "file": file.filename,
                        "page": idx,
                        "status": "âœ… ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
                        "rows_added": len(products),
                        "image_url": image_url,
                        "invoice_data": {
                            "invoice_details": data.get("invoice_details", {}),
                            "supplier_details": data.get("supplier_details", {}),
                            "client_details": data.get("client_details", {}),
                            "product_details": data.get("product_details", []),
                            "invoice_summary": data.get("invoice_summary", {})
                        }
                    })

            # ğŸ–¼ï¸ ØµÙˆØ±Ø© Ù…ÙØ±Ø¯Ø©
            else:
                print(f"ğŸ–¼ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø©: {file.filename}")
                image_path = os.path.join("images", file.filename)
                with open(image_path, "wb") as f:
                    f.write(await file.read())
                image_url = f"http://localhost:8000/images/{file.filename}"

                data = parse_invoice_from_image(image_path)
                supplier = data.get("supplier_details", {}).get("name", "")
                invoice = data.get("invoice_details", {})
                invoice_summary = data.get("invoice_summary", {})
                products = data.get("product_details", [])

                inventory = [{"item_id": k["item_id"], "product_name": k["product_name"], "unit_price": k["unit_price"]} for k in keywords]
                for p in products:
                    match = match_product_with_keywords(p["product_name"], keywords, inventory)
                    p["matched_inventory"] = match["product_name"] if match else ""

                save_invoice(client_id, supplier, invoice, invoice_summary, products, image_url)

                results.append({
                    "file": file.filename,
                    "status": "âœ… ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
                    "rows_added": len(products),
                    "image_url": image_url,
                    "invoice_data": {
                        "invoice_details": data.get("invoice_details", {}),
                        "supplier_details": data.get("supplier_details", {}),
                        "client_details": data.get("client_details", {}),
                        "product_details": data.get("product_details", []),
                        "invoice_summary": data.get("invoice_summary", {})
                    }
                })

        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© {file.filename}: {e}")
            results.append({
                "file": file.filename,
                "status": "âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©",
                "error": str(e)
            })

    print(f"\nğŸ¯ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© {len(files)} Ù…Ù„Ù.\n")
    return {"total": len(results), "processed": results}
