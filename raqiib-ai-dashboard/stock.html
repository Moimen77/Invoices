<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Raqiib AI</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <style>
        .form-container {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }

        .filters-container {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filters-container label {
            font-weight: 600;
        }

        .filters-container select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            min-width: 250px;
            font-size: 15px;
        }

        #inventory_search {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 15px;
            min-width: 250px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        th,
        td {
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 15px;
            text-align: right;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tbody tr:hover {
            background-color: #f9fafb;
        }

        .keyword-tag {
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            margin: 2px;
            display: inline-block;
        }

        .keyword-input {
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            margin-left: 5px;
        }

        .add-keyword-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
        }

        .add-keyword-btn:hover {
            background: #218838;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">ğŸ“Š Raqiib AI</div>
        <ul>
            <li><a href="invoices.html">ğŸ“„ Ø±ÙØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</a></li>
            <li><a href="previous_invoices.html">ğŸ“œ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</a></li>
            <li><a href="clients.html">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a></li>
            <li><a href="stock.html" class="active">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</a></li>
        </ul>
    </div>

    <div class="content">
        <!-- ğŸ” ÙÙ„Ø§ØªØ± -->
        <div class="filters-container">
            <label for="client_filter">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <select id="client_filter">
                <option value="">-- Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ --</option>
            </select>
        </div>

        <!-- â• Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ -->
        <div class="form-container" id="addInventoryFormContainer" style="display: none;">
            <h2>â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù…Ø®Ø²ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h2>
            <form id="addInventoryForm">
                <div class="input-group">
                    <label for="item_name">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:</label>
                    <input type="text" id="item_name" required>
                </div>
                <div class="input-group">
                    <label for="unit_of_measure">ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³:</label>
                    <input type="text" id="unit_of_measure" required>
                </div>
                <div class="input-group">
                    <label for="min_unit">Ø£ØµØºØ± ÙˆØ­Ø¯Ø©:</label>
                    <input type="text" id="min_unit" required>
                </div>
                <div class="input-group">
                    <label for="unit_price">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                    <input type="number" id="unit_price" step="0.01" required>
                </div>
                <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
            </form>
        </div>


        <!-- ğŸ“¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
        <div class="table-container">
            <div class="table-header">
                <h2>ğŸ“¦ Ù‚Ø§Ø¦Ù…Ø© Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
                <input type="text" id="inventory_search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." style="display: none;">
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                        <th>ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³</th>
                        <th>Ø£ØµØºØ± ÙˆØ­Ø¯Ø©</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ Ù…Ø®Ø²ÙˆÙ†Ù‡.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000";
        const clientFilter = document.getElementById("client_filter");
        const tableBody = document.getElementById("inventoryTableBody");
        const addInventoryFormContainer = document.getElementById("addInventoryFormContainer");
        const searchInput = document.getElementById("inventory_search");
        let currentInventory = []; // Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©

        // ğŸŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        async function loadClients() {
            const res = await fetch(`${API_BASE}/clients/get_clients`);
            const result = await res.json();
            if (result.status === "success") {
                clientFilter.innerHTML += result.data.map(c => `<option value="${c.client_id}">${c.client_name}</option>`).join("");
            }
        }

        // ğŸ¨ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function renderInventory(items) {
            if (items.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</td></tr>`;
                return;
            }
            tableBody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.item_name}</td>
                    <td>${item.unit_of_measure}</td>
                    <td>${item.Min_Unit}</td>
                    <td>${item.unit_price}</td>
                    <td>
                        ${item.keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
                        <div style="margin-top: 5px;">
                            <input type="text" class="keyword-input" id="keyword-input-${item.id}" placeholder="Ø£Ø¶Ù ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©...">
                            <button class="add-keyword-btn" onclick="addKeyword(${clientFilter.value}, ${item.id})">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                    </td>
                </tr>`).join("");
        }

        // ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        async function loadInventory(clientId) {
            if (!clientId) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ Ù…Ø®Ø²ÙˆÙ†Ù‡.</td></tr>`;
                addInventoryFormContainer.style.display = "none";
                searchInput.style.display = "none";
                currentInventory = [];
                return;
            }
            addInventoryFormContainer.style.display = "block";
            searchInput.style.display = "inline-block";
            searchInput.value = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†...</td></tr>`;

            try {
                const res = await fetch(`${API_BASE}/invoices/inventory/client/${clientId}`);
                const result = await res.json();

                currentInventory = (result.status === "success" && result.data.length > 0) ? result.data : [];

                if (currentInventory.length > 0) {
                    renderInventory(currentInventory);
                } else {
                    currentInventory = [];
                    tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.</td></tr>`;
                }
            } catch (err) {
                console.error("Error loading inventory:", err);
                currentInventory = [];
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.</td></tr>`;
            }
        }

        // ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
        clientFilter.addEventListener("change", async () => {
            const clientId = clientFilter.value;
            await loadInventory(clientId);
        });

        // ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        searchInput.addEventListener("input", () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const filteredItems = currentInventory.filter(item =>
                item.item_name.toLowerCase().includes(searchTerm)
            );
            renderInventory(filteredItems);
        });

        // ğŸ’¾ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù…Ø®Ø²ÙˆÙ† Ø¬Ø¯ÙŠØ¯
        document.getElementById("addInventoryForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const clientId = clientFilter.value;
            if (!clientId) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }

            const payload = {
                client_id: parseInt(clientId),
                item_name: document.getElementById("item_name").value,
                unit_of_measure: document.getElementById("unit_of_measure").value,
                min_unit: document.getElementById("min_unit").value,
                unit_price: parseFloat(document.getElementById("unit_price").value)
            };

            const res = await fetch(`${API_BASE}/inventory/add`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status === "success") {
                alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!");
                document.getElementById("addInventoryForm").reset();
                await loadInventory(clientId); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            } else {
                alert("âŒ ÙØ´Ù„Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©.");
            }
        });

        // ğŸ”‘ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©
        async function addKeyword(clientId, itemId) {
            const input = document.getElementById(`keyword-input-${itemId}`);
            const keyword = input.value.trim();
            if (!keyword) return;
            await fetch(`${API_BASE}/keywords/add`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ client_id: clientId, item_id: itemId, keyword: keyword })
            });
            input.value = "";
            await loadInventory(clientId); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        }

        // ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener("DOMContentLoaded", loadClients);
    </script>
</body>

</html>